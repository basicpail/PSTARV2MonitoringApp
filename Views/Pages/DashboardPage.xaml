<Page
    x:Class="PSTARV2MonitoringApp.Views.Pages.DashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:PSTARV2MonitoringApp.Views.Pages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:Controls="clr-namespace:PSTARV2MonitoringApp.Views.Controls"
    Title="DashboardPage"
    d:DataContext="{d:DesignInstance local:DashboardPage,
                                     IsDesignTimeCreatable=False}"
    d:DesignHeight="720"
    d:DesignWidth="1280"
    ui:Design.Background="{ui:ThemeResource ApplicationBackgroundBrush}"
    ui:Design.Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"
    Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"
    ScrollViewer.CanContentScroll="True"
    mc:Ignorable="d">

    <!-- 한 번만 선언하는 Resources -->
    <Page.Resources>
        <!-- DataGrid 공통 헤더 스타일 -->
        <Style x:Key="GridHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="#434343"/>
            <Setter Property="Foreground" Value="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="BorderBrush" Value="{DynamicResource DividerColorBrush}"/>
            <Setter Property="Padding" Value="8,6"/>
        </Style>

        <!-- DataGrid RowStyle 정의 -->
        <Style x:Key="NoCornerRadiusRowStyle" TargetType="DataGridRow">
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="BorderBrush" Value="{DynamicResource GridLineBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Background" Value="{DynamicResource RowBackgroundBrush}"/>
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="Margin" Value="1" />
            <!-- Template에서 CornerRadius만 0으로 -->
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DataGridRow">
                        <Border x:Name="RowBorder"
                              Background="{TemplateBinding Background}" 
                              BorderBrush="{TemplateBinding BorderBrush}"
                              BorderThickness="{TemplateBinding BorderThickness}"
                              CornerRadius="3">
                            <DataGridCellsPresenter/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- DataGrid 공통 셀 스타일 -->
        <Style x:Key="GridCellStyle" TargetType="DataGridCell">
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Margin" Value="2,0,0,0" />
        </Style>
    </Page.Resources>
    
    
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="2*" />
            <RowDefinition Height="auto"/>
            <RowDefinition Height="1*"/>
        </Grid.RowDefinitions>

        <!-- 상단: 두 개의 카드 -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- ▶ 종합 상황 정보 카드 (DeviceLogService 사용) -->
            <ui:Card
                Grid.Column="0"
                Background="#323232"
                BorderBrush="#434343"
                BorderThickness="1"
                Margin="0,0,8,0">

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="400"/>
                    </Grid.RowDefinitions>

                    <!-- ① Header 영역 -->
                    <Grid Grid.Row="0" Margin="16,0,16,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <ui:SymbolIcon Symbol="Info28" FontSize="20" FontWeight="Bold" Margin="0,0,8,0" Foreground="#4F8EF7"/>
                            <TextBlock Text="종합 상황 정보"
                                FontSize="20"
                                FontWeight="SemiBold"
                                Foreground="#F3F3F3"
                                VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- 테스트 로그 추가 버튼 -->
                        <ui:Button Grid.Column="1"
                            Content="Test Log"
                            Margin="0,0,8,0"
                            Padding="8,4"
                            CornerRadius="5"
                            Icon="{ui:SymbolIcon Play28}"
                            Command="{Binding ViewModel.AddRandomLogCommand}"
                            Background="#212121"
                            Foreground="#F3F3F3"
                            BorderBrush="#33334D"
                            ToolTip="테스트용 랜덤 로그 추가"/>

                        <!-- 로그 클리어 버튼 -->
                        <ui:Button Grid.Column="2"
                            Content="Clear"
                            Margin="0,0,8,0"
                            Padding="8,4"
                            CornerRadius="5"
                            Icon="{ui:SymbolIcon Delete28}"
                            Command="{Binding ViewModel.ClearLogsCommand}"
                            Background="#212121"
                            Foreground="#F3F3F3"
                            BorderBrush="#33334D"
                            ToolTip="모든 로그 삭제"/>

                        <!-- 필터 버튼 -->
                        <ui:Button Grid.Column="3"
                            Content="필터"
                            Padding="8,4"
                            CornerRadius="5"
                            Icon="{ui:SymbolIcon Filter28}"
                            Command="{Binding ViewModel.ShowLogFilterDialogCommand}"
                            Background="#212121"
                            Foreground="#F3F3F3"
                            BorderBrush="#33334D"
                            ToolTip="ID별 로그 필터링"/>
                    </Grid>

                    <!-- ② Content 영역: DeviceLogService 통합 로그 DataGrid (필터링된 버전) -->
                    <DataGrid
                        Grid.Row="1"
                        ItemsSource="{Binding ViewModel.FilteredDeviceLogs}"
                        ColumnHeaderStyle="{StaticResource GridHeaderStyle}"
                        CellStyle="{StaticResource GridCellStyle}"
                        RowStyle="{StaticResource NoCornerRadiusRowStyle}"
                        AutoGenerateColumns="False"
                        CanUserAddRows="False"
                        HeadersVisibility="Column"
                        GridLinesVisibility="All"
                        RowBackground="#101010"
                        AlternatingRowBackground="#212121"
                        IsReadOnly="True"
                        BorderBrush="#000000"
                        Foreground="#000000"
                        Background="#000000">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="시간"     
                                                Binding="{Binding Date, StringFormat=HH:mm:ss}" 
                                                Width="6*" 
                                                MinWidth="150"/>
                            <DataGridTextColumn Header="장치 ID"       
                                                Binding="{Binding Id}" 
                                                Width="2*" 
                                                MinWidth="50"/>
                            <DataGridTextColumn Header="상황 정보" 
                                                Binding="{Binding Contents}" 
                                                Width="10*"/>
                        </DataGrid.Columns>

                        <!-- 데이터가 없을 때 표시할 메시지 -->
                        <DataGrid.Style>
                            <Style TargetType="DataGrid">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ViewModel.FilteredDeviceLogs.Count}" Value="0">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="DataGrid">
                                                    <Border BorderBrush="{TemplateBinding BorderBrush}" 
                                                            BorderThickness="{TemplateBinding BorderThickness}" 
                                                            Background="{TemplateBinding Background}">
                                                        <Grid>
                                                            <ScrollViewer x:Name="DG_ScrollViewer" Focusable="false">
                                                                <ItemsPresenter x:Name="ItemsPresenter" 
                                                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                                            </ScrollViewer>
                                                            <TextBlock Text="해당 조건의 상황 정보가 없습니다." 
                                                                       Foreground="#F3F3F3" 
                                                                       HorizontalAlignment="Center" 
                                                                       VerticalAlignment="Center" 
                                                                       FontSize="16"
                                                                       Opacity="0.7"/>
                                                        </Grid>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.Style>
                    </DataGrid>
                </Grid>
            </ui:Card>

            <!-- ▶ Raw Data 카드 -->
            <ui:Card
                Grid.Column="1"
                Background="#323232"
                BorderBrush="#434343"
                BorderThickness="1"
                Margin="8,0,0,0">

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="400"/>
                    </Grid.RowDefinitions>

                    <!-- ① Header -->
                    <Grid Grid.Row="0" Margin="16,0,16,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <ui:SymbolIcon Symbol="Info28" FontSize="20" FontWeight="Bold" Margin="0,0,8,0" Foreground="#4F8EF7"/>
                            <TextBlock Text="Raw Data"
                                FontSize="20"
                                FontWeight="SemiBold"
                                Foreground="#F3F3F3"
                                VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- CAN ID 필터 버튼 -->
                        <ComboBox Grid.Column="1" 
                            Margin="8,0,4,0"
                            Width="100"
                            ItemsSource="{Binding ViewModel.AvailableCanIds}"
                            SelectedItem="{Binding ViewModel.SelectedCanIdFilter, Mode=TwoWay}"
                            Background="#212121"
                            Foreground="#F3F3F3"
                            BorderBrush="#33334D"
                            ToolTip="CAN ID 필터"/>
                        
                        <!-- 필터 토글 -->
                        <ui:ToggleSwitch Grid.Column="2"
                            Content="모든 데이터"
                            Margin="4,0,0,0"
                            IsChecked="{Binding ViewModel.ShowAllCanMessages, Mode=TwoWay}"
                            Background="#212121"
                            Foreground="#F3F3F3"
                            BorderBrush="#33334D"
                            ToolTip="모든 CAN 메시지 표시"/>
                    </Grid>

                    <!-- ② Content: Raw Data DataGrid -->
                    <DataGrid
                        Grid.Row="1"
                        ItemsSource="{Binding ViewModel.TestRawDataTimelineItems}"
                        ColumnHeaderStyle="{StaticResource GridHeaderStyle}"
                        CellStyle="{StaticResource GridCellStyle}"
                        RowStyle="{StaticResource NoCornerRadiusRowStyle}"
                        AutoGenerateColumns="False"
                        CanUserAddRows="False"
                        HeadersVisibility="Column"
                        GridLinesVisibility="All"
                        RowBackground="#101010"
                        AlternatingRowBackground="#212121"
                        IsReadOnly="True"
                        BorderBrush="#000000"
                        Foreground="#000000"
                        Background="#000000">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="시간" Binding="{Binding Timestamp}" Width="2*" MinWidth="100"/>
                            <DataGridTextColumn Header="CAN ID" Binding="{Binding CanId}" Width="1*" MinWidth="60"/>
                            <DataGridTextColumn Header="STBY Start" Binding="{Binding STBY_Start}" Width="*" MinWidth="80"/>
                            <DataGridTextColumn Header="Run Lamp" Binding="{Binding RunLamp}" Width="*" MinWidth="80"/>
                            <DataGridTextColumn Header="Overload" Binding="{Binding Overload}" Width="*" MinWidth="80"/>
                            <DataGridTextColumn Header="Mode" Binding="{Binding ModeStatus}" Width="*" MinWidth="80"/>
                            <DataGridTextColumn Header="Run Req" Binding="{Binding RUN_req}" Width="*" MinWidth="80"/>
                            <DataGridTextColumn Header="Reset Btn" Binding="{Binding ResetButton}" Width="*" MinWidth="80"/>
                            <DataGridTextColumn Header="STBY Lamp" Binding="{Binding StandByLamp}" Width="*" MinWidth="80"/>
                            <DataGridTextColumn Header="Low Press" Binding="{Binding TXLowpress}" Width="*" MinWidth="80"/>
                        </DataGrid.Columns>
                        
                        <!-- 데이터가 없을 때 표시할 메시지 -->
                        <DataGrid.Style>
                            <Style TargetType="DataGrid">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ViewModel.TestRawDataTimelineItems.Count}" Value="0">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="DataGrid">
                                                    <Border BorderBrush="{TemplateBinding BorderBrush}" 
                                                            BorderThickness="{TemplateBinding BorderThickness}" 
                                                            Background="{TemplateBinding Background}">
                                                        <Grid>
                                                            <ScrollViewer x:Name="DG_ScrollViewer" Focusable="false">
                                                                <ItemsPresenter x:Name="ItemsPresenter" 
                                                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                                            </ScrollViewer>
                                                            <TextBlock Text="전송된 CAN 데이터가 없습니다." 
                                                                       Foreground="#F3F3F3" 
                                                                       HorizontalAlignment="Center" 
                                                                       VerticalAlignment="Center" 
                                                                       FontSize="16"
                                                                       Opacity="0.7"/>
                                                        </Grid>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.Style>
                    </DataGrid>
                </Grid>
            </ui:Card>
        </Grid>

        <Grid Grid.Row="1">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10">
                <!-- CAN 시뮬레이션 제어 버튼들 -->
                <ui:Button 
                    Content="CAN 시뮬레이션 시작"
                    Command="{Binding ViewModel.StartCANSimulationCommand}"
                    Background="#29A745"
                    Foreground="#F3F3F3"
                    BorderBrush="#0D7F33"
                    Margin="0,0,10,0"
                    ToolTip="가상 CAN 데이터 송수신 시작"/>
                
                <ui:Button 
                    Content="CAN 시뮬레이션 중지"
                    Command="{Binding ViewModel.StopCANSimulationCommand}"
                    Background="#E23B3B"
                    Foreground="#F3F3F3"
                    BorderBrush="#9D1E1E"
                    Margin="0,0,10,0"
                    ToolTip="가상 CAN 데이터 송수신 중지"/>
                
                <ui:Button 
                    Content="CAN 설정"
                    Command="{Binding ViewModel.ShowCANSettingsCommand}"
                    Background="#17A2B8"
                    Foreground="#F3F3F3"
                    BorderBrush="#117A8B"
                    Margin="0,0,10,0"
                    ToolTip="CAN 통신 설정"/>
            </StackPanel>
        </Grid>
        
        <!-- 하단: 개별 ID 상태 카드 3개 -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Grid x:Name="deviceCard" Grid.Column="0" Visibility="Visible">
                <Controls:DeviceStatusCard DataContext="{Binding DeviceStatusCardViewModel.DeviceStatusCardModels}"/>
            </Grid>
        </Grid>
    </Grid>
</Page>
